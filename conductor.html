<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conductor Terminal - Smart Bus</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e8f5e9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        
        @media print {
            .container, button, #reader, .drop-zone, #stop-cam { display: none !important; }
            #ticket-receipt { display: block !important; border: none !important; width: 100%; }
        }

        .input-group { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-top: 5px; }
        
        .issue-btn { width: 100%; padding: 15px; background-color: #2e7d32; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        #ticket-receipt { display: none; background: #fffbe6; border: 2px solid #fadb14; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .total-box { background: #2e7d32; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px; }
        
        /* Camera Styling */
        #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“Ÿ Conductor Terminal</h2>
    
    <div id="reader"></div>
    
    <div class="drop-zone" onclick="document.getElementById('qr-input-file').click()" style="border: 2px dashed #2e7d32; padding: 15px; text-align: center; cursor: pointer; border-radius: 10px; margin-bottom: 10px;">
        Tap to Upload QR Image (Instead of Cam)
    </div>
    <input type="file" id="qr-input-file" accept="image/*" style="display:none">

    <div class="input-group">
        <label>Card ID</label>
        <input type="text" id="cardId" readonly placeholder="Camera Result Here">
    </div>

    <div style="display:flex; gap:10px">
        <div class="input-group" style="flex:1">
            <label>From</label>
            <input type="text" id="fromLoc" placeholder="Origin" oninput="calculateTotal()">
        </div>
        <div class="input-group" style="flex:1">
            <label>To</label>
            <input type="text" id="toLoc" placeholder="Destination" oninput="calculateTotal()">
        </div>
    </div>

    <div class="input-group">
        <label>How Many Tickets?</label>
        <input type="number" id="ticketCount" value="1" min="1" oninput="calculateTotal()">
    </div>

    <div class="total-box">
        Total Fare: â‚¹<span id="displayTotal">0</span>
    </div>

    <button class="issue-btn" style="margin-top:15px" onclick="processTicket()">DEDUCT & ISSUE</button>
</div>

<div id="ticket-receipt">
    <h3 style="text-align:center; border-bottom: 2px dashed #000; padding-bottom: 10px;">SMART BUS RECEIPT</h3>
    <div class="row"><span>Passenger:</span> <b id="tName"></b></div>
    <div class="row"><span>Route:</span> <span id="tRoute"></span></div>
    <div class="row"><span>Tickets:</span> <b id="tQty"></b></div>
    <div class="row"><span>Total Paid:</span> <b id="tTotal"></b></div>
    <div class="row" style="color: green; border-top: 1px solid #ccc; padding-top: 5px;">
        <span>Remaining Bal:</span> <b id="tBalance"></b>
    </div>
    <div class="row" style="font-size: 11px; margin-top: 10px;">
        <span>Time:</span> <span id="tTime"></span>
    </div>
    <button class="print-hide" onclick="window.print()" style="width:100%; padding:10px; margin-top:15px; background:#000; color:#fff; border-radius:5px;">Print Receipt</button>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDkt8VhTVIE4tj6R-nWQE_1j7EQdyPIpm8",
        authDomain: "smartbuscard.firebaseapp.com",
        databaseURL: "https://smartbuscard-default-rtdb.firebaseio.com",
        projectId: "smartbuscard",
        storageBucket: "smartbuscard.firebasestorage.app",
        messagingSenderId: "740841885323",
        appId: "1:740841885323:web:87c2ec39e01ffb533f8e8e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. Calculate Total based on Route & Quantity
    function calculateTotal() {
        const from = document.getElementById('fromLoc').value.trim().toLowerCase();
        const to = document.getElementById('toLoc').value.trim().toLowerCase();
        const qty = parseInt(document.getElementById('ticketCount').value) || 1;
        
        let unitFare = 0;
        if (from && to) {
            unitFare = (from.length + to.length) > 10 ? 25 : 15;
            if (from === "india" && to === "rajastan") unitFare = 15;
        }
        
        document.getElementById('displayTotal').innerText = unitFare * qty;
    }

    // 2. Full Camera QR Scanner Integration
    function onScanSuccess(decodedText) {
        // Auto-fill the Card ID when QR is detected
        document.getElementById('cardId').value = decodedText;
        // Visual feedback
        document.getElementById('cardId').style.background = "#e8f5e9";
    }

    function onScanFailure(error) {
        // We ignore failures to avoid console spam during live scanning
    }

    // Initializing the Scanner
    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 15, qrbox: {width: 250, height: 250} }, 
        /* verbose= */ false
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

    // 3. File Upload Scan (Fallback)
    document.getElementById('qr-input-file').addEventListener('change', e => {
        if (e.target.files.length == 0) return;
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.scanFile(e.target.files[0], true)
            .then(text => { document.getElementById('cardId').value = text; })
            .catch(err => alert("QR Not Found in image"));
    });

    // 4. Final Transaction
    function processTicket() {
        const cid = document.getElementById('cardId').value;
        const totalFare = parseFloat(document.getElementById('displayTotal').innerText);
        const qty = document.getElementById('ticketCount').value;

        if (!cid || totalFare <= 0) { alert("Please scan card and enter route!"); return; }

        db.ref('cards/' + cid).once('value').then(snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.balance >= totalFare) {
                    const newBal = data.balance - totalFare;
                    db.ref('cards/' + cid).update({ balance: newBal }).then(() => {
                        document.getElementById('ticket-receipt').style.display = "block";
                        document.getElementById('tName').innerText = data.name;
                        document.getElementById('tRoute').innerText = document.getElementById('fromLoc').value + " to " + document.getElementById('toLoc').value;
                        document.getElementById('tQty').innerText = qty;
                        document.getElementById('tTotal').innerText = "â‚¹" + totalFare;
                        document.getElementById('tBalance').innerText = "â‚¹" + newBal;
                        document.getElementById('tTime').innerText = new Date().toLocaleString();
                        document.getElementById('ticket-receipt').scrollIntoView();
                    });
                } else { alert("Insufficient Balance! Available: â‚¹" + data.balance); }
            } else { alert("Invalid Card!"); }
        });
    }
</script>

</body>
</html>
