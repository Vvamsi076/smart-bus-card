<!DOCTYPE html>
<html>
<head>
    <title>Conductor - Smart Bus</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; background: #e8f5e9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #ticket-receipt { display: none; background: #fffbe6; border: 2px dashed #000; padding: 15px; margin-top: 20px; width: 100%; }
        @media print { .container, #reader { display: none !important; } #ticket-receipt { display: block !important; } }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“Ÿ Conductor Terminal</h2>
    <div id="reader"></div>
    <input type="text" id="cardId" readonly placeholder="Scan Card QR">
    <input type="text" id="from" placeholder="From" oninput="checkFare()">
    <input type="text" id="to" placeholder="To" oninput="checkFare()">
    <input type="number" id="qty" value="1" min="1" oninput="checkFare()">
    
    <div style="background:#f1f1f1; padding:10px; margin:10px 0; text-align:center; font-weight:bold;">
        Total: â‚¹<span id="total">0</span>
    </div>
    <button class="btn" onclick="issueTicket()">DEDUCT & PRINT</button>
</div>

<div id="ticket-receipt">
    <h3 style="text-align:center;">BUS TICKET</h3>
    <p><b>Date:</b> <span id="rDate"></span></p>
    <p><b>Bus No:</b> <span id="rBus"></span></p>
    <hr>
    <p><b>Passenger:</b> <span id="rName"></span></p>
    <p><b>Route:</b> <span id="rRoute"></span></p>
    <p><b>Tickets:</b> <span id="rQty"></span></p>
    <p><b>Total Paid:</b> â‚¹<span id="rPaid"></span></p>
    <p style="color:green;"><b>Balance Left:</b> â‚¹<span id="rBal"></span></p>
    <button onclick="window.print()" style="width:100%; margin-top:10px;">Click to Print</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDkt8VhTVIE4tj6R-nWQE_1j7EQdyPIpm8",
        authDomain: "smartbuscard.firebaseapp.com",
        databaseURL: "https://smartbuscard-default-rtdb.firebaseio.com",
        projectId: "smartbuscard",
        storageBucket: "smartbuscard.firebasestorage.app",
        messagingSenderId: "740841885323",
        appId: "1:740841885323:web:87c2ec39e01ffb533f8e8e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. Check Fare from Admin Settings
    function checkFare() {
        const f = document.getElementById('from').value.toLowerCase().trim();
        const t = document.getElementById('to').value.toLowerCase().trim();
        const q = document.getElementById('qty').value;
        const key = f + "_" + t;

        db.ref('bus_settings/routes/' + key).once('value', snap => {
            if(snap.exists()){
                document.getElementById('total').innerText = snap.val().price * q;
            } else {
                document.getElementById('total').innerText = "0";
            }
        });
    }

    // 2. Camera Scanner
    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render((text) => { document.getElementById('cardId').value = text; });

    // 3. Process Ticket
    function issueTicket() {
        const cid = document.getElementById('cardId').value;
        const total = parseFloat(document.getElementById('total').innerText);
        if(!cid || total <= 0) { alert("Check Card/Route!"); return; }

        db.ref('cards/' + cid).once('value', snapshot => {
            if(snapshot.exists()){
                const user = snapshot.val();
                if(user.balance >= total){
                    const newBal = user.balance - total;
                    db.ref('cards/' + cid).update({ balance: newBal });
                    
                    // Fetch Bus Info for Receipt
                    db.ref('bus_settings/info').once('value', infoSnap => {
                        const info = infoSnap.val();
                        document.getElementById('rDate').innerText = info.travelDate;
                        document.getElementById('rBus').innerText = info.busNumber;
                        document.getElementById('rName').innerText = user.name;
                        document.getElementById('rRoute').innerText = document.getElementById('from').value + " to " + document.getElementById('to').value;
                        document.getElementById('rQty').innerText = document.getElementById('qty').value;
                        document.getElementById('rPaid').innerText = total;
                        document.getElementById('rBal').innerText = newBal;
                        document.getElementById('ticket-receipt').style.display = "block";
                    });
                } else { alert("Insufficient Balance!"); }
            } else { alert("Card Invalid!"); }
        });
    }
</script>
</body>
</html>
