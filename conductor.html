<!DOCTYPE html>
<html>
<head>
    <title>Conductor - Smart Bus Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e8f5e9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        #shift-summary { margin-top: 20px; background: #263238; color: white; padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; }
        .summary-item { display: flex; justify-content: space-between; margin: 5px 0; border-bottom: 1px solid #455a64; padding-bottom: 5px; }
        
        #ticket-receipt { display: none; background: #fffbe6; border: 2px dashed #000; padding: 15px; margin-top: 20px; width: 100%; }
        .warning { color: #d32f2f; font-weight: bold; background: #ffcdd2; padding: 5px; border-radius: 4px; text-align: center; margin: 10px 0; display: none; }
        .reset-btn { background: #cfd8dc; color: #37474f; border: none; padding: 5px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; float: right; }
        @media print { .container, #reader, #shift-summary, .btn { display: none !important; } #ticket-receipt { display: block !important; } }
    </style>
</head>
<body>

<div class="container">
    <h2>üìü Conductor Terminal</h2>
    <div id="reader"></div>
    
    <div id="low-balance-warning" class="warning">‚ö†Ô∏è PASSENGER LOW BALANCE</div>

    <input type="text" id="cardId" readonly placeholder="Scan Card QR">
    <input type="text" id="from" placeholder="From (Place)" oninput="checkFare()">
    <input type="text" id="to" placeholder="To (Place)" oninput="checkFare()">
    <input type="number" id="qty" value="1" min="1" oninput="checkFare()">
    
    <div style="background:#f1f1f1; padding:10px; margin:10px 0; text-align:center; font-weight:bold;">
        Total: ‚Çπ<span id="total">0</span>
    </div>
    <button class="btn" onclick="issueTicket()">DEDUCT & PRINT</button>
</div>

<div id="shift-summary">
    <button class="reset-btn" onclick="resetShift()">ERASE DATA</button>
    <h3 style="margin-top:0; color:#81c784;">üìä Shift Summary</h3>
    <div class="summary-item"><span>Tickets Issued Today:</span> <span id="sQty">0</span></div>
    <div class="summary-item"><span>Total Cash Collected:</span> <span>‚Çπ<span id="sCash">0</span></span></div>
</div>

<div id="ticket-receipt">
    <h3 style="text-align:center;">BUS TICKET</h3>
    <p><b>Date:</b> <span id="rDate"></span></p>
    <p><b>Bus No:</b> <span id="rBus"></span></p>
    <hr>
    <p><b>Passenger:</b> <span id="rName"></span></p>
    <p><b>Route:</b> <span id="rRoute"></span></p>
    <p><b>Tickets:</b> <span id="rQty"></span></p>
    <p><b>Total Paid:</b> ‚Çπ<span id="rPaid"></span></p>
    <p style="color:green;"><b>Balance Left:</b> ‚Çπ<span id="rBal"></span></p>
    <button onclick="window.print()" style="width:100%; margin-top:10px; background:black; color:white; padding:10px; border-radius:5px;">Print Receipt</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDkt8VhTVIE4tj6R-nWQE_1j7EQdyPIpm8",
        authDomain: "smartbuscard.firebaseapp.com",
        databaseURL: "https://smartbuscard-default-rtdb.firebaseio.com",
        projectId: "smartbuscard",
        storageBucket: "smartbuscard.firebasestorage.app",
        messagingSenderId: "740841885323",
        appId: "1:740841885323:web:87c2ec39e01ffb533f8e8e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let lastScannedId = "";
    let lastScanTime = 0;

    // Load existing Shift Data from Firebase on startup
    db.ref('bus_settings/shift_totals').on('value', snap => {
        if(snap.exists()){
            document.getElementById('sQty').innerText = snap.val().totalTickets || 0;
            document.getElementById('sCash').innerText = snap.val().totalCash || 0;
        }
    });

    function checkFare() {
        const f = document.getElementById('from').value.toLowerCase().trim();
        const t = document.getElementById('to').value.toLowerCase().trim();
        const q = document.getElementById('qty').value;
        const key = f + "_" + t;

        db.ref('bus_settings/routes/' + key).once('value', snap => {
            if(snap.exists()){
                document.getElementById('total').innerText = snap.val().price * q;
            } else {
                document.getElementById('total').innerText = "0";
            }
        });
    }

    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render((text) => { 
        document.getElementById('cardId').value = text;
        checkLowBalance(text);
    });

    function checkLowBalance(cid) {
        db.ref('cards/' + cid).once('value', snap => {
            if(snap.exists() && snap.val().balance < 30) {
                document.getElementById('low-balance-warning').style.display = "block";
            } else {
                document.getElementById('low-balance-warning').style.display = "none";
            }
        });
    }

    function issueTicket() {
        const cid = document.getElementById('cardId').value;
        const total = parseFloat(document.getElementById('total').innerText);
        const qtyToIssue = parseInt(document.getElementById('qty').value);
        const currentTime = Date.now();

        if(cid === lastScannedId && (currentTime - lastScanTime) < 60000) {
            alert("Fraud Prevention: Card scanned too recently!");
            return;
        }

        if(!cid || total <= 0) { alert("Invalid Details!"); return; }

        db.ref('cards/' + cid).once('value', snapshot => {
            if(snapshot.exists()){
                const user = snapshot.val();
                if(user.balance >= total){
                    const newBal = user.balance - total;
                    
                    // Update Passenger Balance
                    db.ref('cards/' + cid).update({ balance: newBal });

                    // Update Shift Totals in Firebase (Persistent Storage)
                    db.ref('bus_settings/shift_totals').transaction((currentData) => {
                        if (currentData === null) {
                            return { totalTickets: qtyToIssue, totalCash: total };
                        } else {
                            return {
                                totalTickets: (currentData.totalTickets || 0) + qtyToIssue,
                                totalCash: (currentData.totalCash || 0) + total
                            };
                        }
                    });

                    lastScannedId = cid;
                    lastScanTime = currentTime;

                    db.ref('bus_settings/info').once('value', infoSnap => {
                        const info = infoSnap.val();
                        document.getElementById('rDate').innerText = info.travelDate;
                        document.getElementById('rBus').innerText = info.busNumber;
                        document.getElementById('rName').innerText = user.name;
                        document.getElementById('rRoute').innerText = document.getElementById('from').value + " to " + document.getElementById('to').value;
                        document.getElementById('rQty').innerText = qtyToIssue;
                        document.getElementById('rPaid').innerText = total;
                        document.getElementById('rBal').innerText = newBal;
                        document.getElementById('ticket-receipt').style.display = "block";
                    });
                } else { alert("Insufficient Balance!"); }
            } else { alert("Card Invalid!"); }
        });
    }

    // Function to erase data manually when shift ends
    function resetShift() {
        if(confirm("Are you sure you want to erase today's shift totals?")) {
            db.ref('bus_settings/shift_totals').set({
                totalTickets: 0,
                totalCash: 0
            });
        }
    }
</script>
</body>
</html>
