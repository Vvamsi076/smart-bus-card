<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conductor Terminal - Smart Bus</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e8f5e9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { color: #2e7d32; text-align: center; }
        
        /* Hidden UI for Printing */
        @media print {
            body { background: white; padding: 0; }
            .container, .drop-zone, .input-group, .issue-btn, #reader, h2 { display: none !important; }
            #ticket-receipt { display: block !important; border: none !important; box-shadow: none !important; width: 100%; margin: 0; }
            .print-hide { display: none !important; }
        }

        .drop-zone { border: 2px dashed #2e7d32; padding: 20px; text-align: center; color: #2e7d32; cursor: pointer; margin-bottom: 15px; border-radius: 10px; }
        .input-group { margin-bottom: 10px; }
        label { font-size: 12px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-top: 5px; }
        
        .issue-btn { width: 100%; padding: 15px; background-color: #2e7d32; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 15px; }
        
        #ticket-receipt { display: none; background: #fffbe6; border: 2px solid #fadb14; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-header { border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; text-align: center; font-size: 18px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; }
        .fare-badge { background: #2e7d32; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; display: inline-block; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“Ÿ Conductor Terminal</h2>
    
    <div id="reader"></div>
    <div class="drop-zone" id="drop-area">Drag & Drop QR Image Here or Click to Upload</div>
    <input type="file" id="qr-input-file" accept="image/*" style="display:none">

    <div class="input-group">
        <label>Card Number</label>
        <input type="text" id="cardId" placeholder="Waiting for Scan...">
    </div>

    <div style="display:flex; gap:10px">
        <div class="input-group" style="flex:1">
            <label>From</label>
            <input type="text" id="fromLoc" placeholder="Origin" oninput="updateFare()">
        </div>
        <div class="input-group" style="flex:1">
            <label>To</label>
            <input type="text" id="toLoc" placeholder="Destination" oninput="updateFare()">
        </div>
    </div>

    <div class="input-group">
        <label>Calculated Fare</label><br>
        <div class="fare-badge">â‚¹<span id="displayFare">0</span></div>
    </div>

    <button class="issue-btn" onclick="processTicket()">DEDUCT & ISSUE TICKET</button>
</div>

<div id="ticket-receipt">
    <div class="receipt-header">SMART BUS TICKET</div>
    <div class="row"><span>Passenger:</span> <b id="tName"></b></div>
    <div class="row"><span>Bus No:</span> <b>TS-09-5566</b></div>
    <div class="row"><span>Route:</span> <span id="tRoute"></span></div>
    <div class="row"><span>Card ID:</span> <span id="tCard"></span></div>
    <div class="row"><span>Time:</span> <span id="tTime"></span></div>
    <div class="row" style="border-top: 1px solid #000; padding-top: 10px;">
        <span>Fare Paid:</span> <b id="tFare"></b>
    </div>
    <div class="row" style="color: green;">
        <span>New Balance:</span> <b id="tBalance"></b>
    </div>
    <p style="font-size: 10px; text-align: center; margin-top: 15px;">Have a safe journey!</p>
    <button class="print-hide" onclick="window.print()" style="width:100%; padding:10px; margin-top:10px; background:#000; color:#fff; border-radius:5px;">Print Physical Receipt</button>
</div>

<script>
    // Use your specific Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDkt8VhTVIE4tj6R-nWQE_1j7EQdyPIpm8",
        authDomain: "smartbuscard.firebaseapp.com",
        databaseURL: "https://smartbuscard-default-rtdb.firebaseio.com",
        projectId: "smartbuscard",
        storageBucket: "smartbuscard.firebasestorage.app",
        messagingSenderId: "740841885323",
        appId: "1:740841885323:web:87c2ec39e01ffb533f8e8e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Auto-Fare Logic: Simplistic calculation based on text length or keywords
    function updateFare() {
        const from = document.getElementById('fromLoc').value.trim().toLowerCase();
        const to = document.getElementById('toLoc').value.trim().toLowerCase();
        let price = 0;

        if (from && to) {
            // Example logic: if travel is between different states or long words, charge more
            price = (from.length + to.length) > 10 ? 25 : 15;
            if (from === "india" && to === "rajastan") price = 15; // Your specific example
        }
        document.getElementById('displayFare').innerText = price;
    }

    // QR Logic
    const html5QrCode = new Html5Qrcode("reader");
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('qr-input-file');

    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
        if (e.target.files.length == 0) return;
        html5QrCode.scanFile(e.target.files[0], true)
            .then(text => { document.getElementById('cardId').value = text; })
            .catch(err => alert("QR Not Detected"));
    });

    function processTicket() {
        const cid = document.getElementById('cardId').value;
        const fare = parseFloat(document.getElementById('displayFare').innerText);
        const from = document.getElementById('fromLoc').value;
        const to = document.getElementById('toLoc').value;

        if (!cid || fare <= 0) { alert("Invalid Card or Route!"); return; }

        db.ref('cards/' + cid).once('value').then(snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.balance >= fare) {
                    const newBal = data.balance - fare;
                    db.ref('cards/' + cid).update({ balance: newBal }).then(() => {
                        // Success - Fill and Show Receipt
                        document.getElementById('ticket-receipt').style.display = "block";
                        document.getElementById('tName').innerText = data.name;
                        document.getElementById('tRoute').innerText = from + " âž” " + to;
                        document.getElementById('tCard').innerText = cid;
                        document.getElementById('tFare').innerText = "â‚¹" + fare;
                        document.getElementById('tBalance').innerText = "â‚¹" + newBal;
                        document.getElementById('tTime').innerText = new Date().toLocaleTimeString();
                        
                        // Scroll to ticket
                        document.getElementById('ticket-receipt').scrollIntoView();
                    });
                } else { alert("Insufficient Balance! Current: â‚¹" + data.balance); }
            } else { alert("Card not found in database!"); }
        });
    }
</script>

</body>
</html>
